{
  "builders": [
    {
      "type": "amazon-ebs",
      "region": "eu-west-2",
      "availability_zone": "eu-west-2a",
      "source_ami": "ami-fcc4db98",
      "instance_type": "t2.micro",
      "ssh_username": "ubuntu",
      "ami_name": "jenkins-slave-{{timestamp}}",
      "iam_instance_profile": "PackerRole",
      "tags": {
        "Name": "Jenkins Slave"
      }
    }
  ],
  "provisioners": [
    {
      "type": "file",
      "source": "./gradle.properties",
      "destination": "/home/ubuntu/gradle.properties"
    },
    {
      "type": "file",
      "source": "./id_rsa_jenkins_np.pub",
      "destination": "/home/ubuntu/id_rsa_jenkins_np.pub"
    },
    {
      "type": "file",
      "source": "./jenkins.asc",
      "destination": "/home/ubuntu/jenkins.asc"
    },
    {
      "type": "file",
      "source": "./passphrase.txt",
      "destination": "/home/ubuntu/passphrase.txt"
    },
    {
      "type": "file",
      "source": "./settings.xml",
      "destination": "/home/ubuntu/settings.xml"
    },
    {
      "type": "shell",
      "inline": [
        "sudo apt-get update",
        "sudo apt-get install openjdk-8-jdk -y",
        "sudo apt-get clean",

        "sudo groupadd -g 1001 jenkins",
        "sudo useradd -d /home/jenkins -u 1001 -g 1001 -m -s /bin/bash jenkins",

        "sudo chown jenkins:jenkins jenkins.asc passphrase.txt settings.xml gradle.properties id_rsa_jenkins_np.pub",

        "sudo mv jenkins.asc passphrase.txt /home/jenkins/",
        "sudo su - jenkins -c 'mkdir .gnupg'",
        "sudo chmod 0700 /home/jenkins/.gnupg",
        "sudo su - jenkins -c 'echo allow-loopback-pinentry > .gnupg/gpg-agent.conf'",
        "sudo su - jenkins -c 'gpg --no-tty --passphrase-file passphrase.txt --import jenkins.asc'",
        "sudo su - jenkins -c 'rm jenkins.asc passphrase.txt'",

        "sudo su - jenkins -c 'mkdir .m2'",
        "sudo mv settings.xml /home/jenkins/.m2",

        "sudo su - jenkins -c 'mkdir .gradle'",
        "sudo mv gradle.properties /home/jenkins/.gradle/",

        "sudo su - jenkins -c 'mkdir .ssh'",
        "sudo chmod 0700 -R /home/jenkins/.ssh",
        "sudo mv id_rsa_jenkins_np.pub /home/jenkins/.ssh/authorized_keys",

        "sudo su - jenkins -c 'git config --global user.email \"jenkins@deliverymind.co.uk\"'",
        "sudo su - jenkins -c 'git config --global user.name \"Jenkins\"'"
      ]
    }
  ]
}